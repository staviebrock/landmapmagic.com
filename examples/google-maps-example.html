<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LandMapMagic - Google Maps + CLU</title>
    
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>

    <!-- deck.gl dependencies for Google Maps integration -->
    <script src="https://unpkg.com/deck.gl@^9.0.0/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/google-maps@^9.0.0/dist.min.js"></script>
</head>
<body>
    <div id="map"></div>

    <!-- Google Maps API will be loaded dynamically -->

    <script>
        /**
         * LandMapMagic Google Maps Integration
         * 
         * Simple example showing CLU field boundaries + acreage labels
         * using deck.gl MVTLayer with PMTiles backend
         */

        // Access deck.gl classes from global namespace (loaded via script tags)
        const { GoogleMapsOverlay } = deck;
        const { MVTLayer } = deck;
        const { TextLayer } = deck;

        // Environment variables injected by Vite at build/serve time
        // To set up: Copy env.example to .env.local and add your API keys
        const GOOGLE_MAPS_KEY = '%VITE_GOOGLE_MAPS_API_KEY%';
        const LANDMAP_KEY = '%VITE_LAND_MAP_MAGIC_API_KEY%';
        const BASE_URL_ENV = '%VITE_LAND_MAP_MAGIC_API_URL%';

        // Check if env vars are set (not placeholders)
        const googleApiKey = (GOOGLE_MAPS_KEY && !GOOGLE_MAPS_KEY.includes('VITE_')) ? GOOGLE_MAPS_KEY : '';
        const landmapApiKey = (LANDMAP_KEY && !LANDMAP_KEY.includes('VITE_')) ? LANDMAP_KEY : 'dev';
        const BASE_URL = (BASE_URL_ENV && !BASE_URL_ENV.includes('VITE_')) ? BASE_URL_ENV : 'https://api.landmapmagic.com';
        
        // Note: 'dev' fallback only works in development environment
        // For staging/production, you must set VITE_LAND_MAP_MAGIC_API_KEY and VITE_LAND_MAP_MAGIC_API_URL in .env.local

        if (!googleApiKey) {
            document.body.innerHTML = '<div style="padding:20px;color:red;">Missing VITE_GOOGLE_MAPS_API_KEY in .env.local</div>';
            throw new Error('Missing Google Maps API key');
        }

        // Your LandMapMagic API endpoint
        const TILE_URL = `${BASE_URL}/clu/{z}/{x}/{y}?key=${landmapApiKey}`;

        // Helper to format acres with 2 decimal places (no "ac" suffix)
        const fmtAcres = (v) => (v == null ? '' : v.toFixed(2));

        // Load Google Maps dynamically
        function loadGoogleMaps() {
            return new Promise((resolve, reject) => {
                if (typeof google !== 'undefined' && google.maps) {
                    resolve();
                    return;
                }

                window.initGoogleMapCallback = resolve;
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&callback=initGoogleMapCallback`;
                script.async = true;
                script.defer = true;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Initialize map
        async function initMap() {
            await loadGoogleMaps();

            // 1) Create Google Map
            const map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 41.878, lng: -93.097 }, // Iowa
                zoom: 13, // Start at zoom 13 so labels are visible
                mapId: 'DEMO_MAP_ID',
                mapTypeId: 'satellite'
            });

            // 2) CLU Polygons (source-layer "clu")
            const cluPolygons = new MVTLayer({
                id: 'clu-polygons',
                data: TILE_URL,
                loadOptions: { 
                    mvt: { 
                        layers: ['clu']  // Only load 'clu' layer for polygons
                    } 
                },
                minZoom: 11,
                maxZoom: 15,
                filled: false,
                stroked: true,
                getLineColor: [253, 224, 71, 230], // #fde047 yellow
                getLineWidth: 2,
                lineWidthMinPixels: 2,
                lineWidthMaxPixels: 4,
                pickable: true,
                onClick: (info) => {
                    if (!info.object) return;
                    const props = info.object.properties || {};
                    const acres = props.calcacres || props.CALCACRES || 'Unknown';
                    const fieldId = props.id || props.ID || 'N/A';
                    alert(`ðŸŒ¾ CLU Field\n\nAcres: ${acres}\nField ID: ${fieldId}`);
                    console.log('CLU polygon:', props);
                }
            });

            // 3) CLU Labels as TEXT (source-layer "clu_labels")
            const cluLabels = new MVTLayer({
                id: 'clu-labels',
                data: TILE_URL,
                binary: false,  // Required to use TextLayer in renderSubLayers
                loadOptions: { 
                    mvt: { 
                        layers: ['clu_labels']  // Only load 'clu_labels' layer for points
                    } 
                },
                minZoom: 13,  // Labels start at zoom 13
                maxZoom: 15,
                pickable: false,

                // Override renderSubLayers to turn point features into TextLayer
                renderSubLayers: (sublayerProps) => {
                    const { data } = sublayerProps;

                    if (!data || !data.length) {
                        return null;
                    }

                    return new TextLayer({
                        ...sublayerProps,
                        id: `${sublayerProps.id}-text`,
                        data,
                        // MVT points come through as GeoJSON features
                        getPosition: (f) => f.geometry.coordinates,
                        getText: (f) => {
                            const props = f.properties || {};
                            const acres = props.calcacres || props.CALCACRES;
                            return fmtAcres(acres);
                        },
                        getSize: 13,
                        sizeUnits: 'pixels',
                        getColor: [0, 0, 0, 255],  // Black text
                        getTextAnchor: 'middle',
                        getAlignmentBaseline: 'center',
                        
                        // White outline for contrast - requires SDF fonts
                        fontSettings: {
                            sdf: true,
                            fontSize: 64,
                            buffer: 4
                        },
                        outlineWidth: 6,  // White outline
                        outlineColor: [255, 255, 255, 255],
                        
                        // Font styling
                        fontFamily: 'Arial, sans-serif',
                        // fontWeight: 'bold',
                        
                        pickable: false
                    });
                }
            });

            // 4) Mount on Google Maps
            const overlay = new GoogleMapsOverlay({
                layers: [cluPolygons, cluLabels]
            });
            overlay.setMap(map);

            console.log('âœ… Map initialized with CLU data');
        }

        // Auto-initialize on load
        initMap().catch((error) => {
            console.error('Failed to initialize map:', error);
            document.body.innerHTML = `<div style="padding:20px;color:red;">Failed to load map: ${error.message}</div>`;
        });
    </script>
</body>
</html>
